name: Format Requirements
on:
  issues:
    types: [opened]
jobs:
  format_requirements:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      final_message: ${{ steps.run_codex.outputs.final-message }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Format Requirements Issue
        id: run_codex
        uses: openai/codex-action@v1
        with:
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          prompt: |
            This is issue #${{ github.event.issue.number }} for ${{ github.repository }}.

            You are a requirements analyst. Your task is to transform the issue content into a detailed, structured requirements document.

            Issue title: ${{ github.event.issue.title }}
            Issue body:
            ----
            ${{ github.event.issue.body }}
            ----

            ## Your Task:

            ### If the issue content is ABSTRACT or VAGUE:
            1. Extract the core concept or objective
            2. Elaborate on the requirements by:
               - Breaking down the abstract idea into specific, actionable requirements
               - Identifying technical specifications, user interactions, and system behaviors
               - Considering edge cases, constraints, and non-functional requirements
               - Adding measurable acceptance criteria where applicable
               - Inferring common industry best practices for this type of feature/system
            3. If critical information is missing, include a "Clarification Needed" section with specific questions

            ### If the issue content is ALREADY SPECIFIC and DETAILED:
            1. Proofread and refine the language for clarity and consistency
            2. Organize the requirements logically
            3. Ensure each requirement is:
               - Clear and unambiguous
               - Testable and measurable
               - Properly formatted
            4. Fix any grammatical or structural issues

            ## Output Format:

            > [!NOTE]
            > Generated by AI.

            # Requirements Document

            Created: ${{ github.event.issue.created_at }} | Last Updated: ${{ github.event.issue.updated_at }}

            ## Purpose
            [Clear statement of the main objective and business value]

            ## Requirements (To-Be)

            |       ID       |     Requirement    |     Acceptance Criteria    |
            | -------------- | ------------------ | -------------------------- |
            | R001           | [Detailed requirement 1] | [How to verify this requirement] |
            | R002           | [Detailed requirement 2] | [How to verify this requirement] |

            ## Constraints
            [Any technical, business, or resource constraints if applicable]

            ## Clarification Needed
            [List specific questions if the original issue was too abstract. Omit this section if everything is clear.]

            ## Guidelines:
            - Number requirements sequentially as R001, R002, R003, etc.
            - Each requirement should follow the format: "The system shall/must/should [action]"
            - Add measurable acceptance criteria for each requirement
            - Format dates as YYYY-MM-DD
            - Generate the entire document in the same language as the issue content
            - Be thorough: transform vague ideas into 5-15+ specific, detailed requirements
            - Consider functional requirements, non-functional requirements (performance, security, usability), and edge cases
  update_issue:
    runs-on: ubuntu-latest
    needs: format_requirements
    permissions:
      issues: write
    steps:
      - run: gh issue edit $ISSUE_NUMBER --body "$CODEX_FINAL_MESSAGE" --add-label "$LABELS" --repo "$REPO"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          CODEX_FINAL_MESSAGE: ${{ needs.format_requirements.outputs.final_message }}
          LABELS: doc-type:requirements,doc-state:draft
          REPO: ${{ github.repository }}
